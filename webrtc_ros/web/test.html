<html>
<head>
<title>WebRTC ROS</title>
<script>
  RTCPeerConnection = window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
  RTCSessionDescription = window.mozRTCSessionDescription || window.RTCSessionDescription;
  RTCIceCandidate = window.mozRTCIceCandidate || window.RTCIceCandidate;
  navigator.getUserMedia = navigator.mozGetUserMedia || navigator.webkitGetUserMedia;
  URL = window.webkitURL || window.URL;

  var mediaConstraints = {'mandatory': {
      'OfferToReceiveAudio': true,
      'OfferToReceiveVideo': true
  }};

  var pc;
  var pcOptions = {
      optional: [
          {DtlsSrtpKeyAgreement: true}
      ]
  }

  var connection = new WebSocket('ws://'+window.location.host+'/webrtc');

  function configure() {
      subscribed_video_topic_name = document.getElementById("subscribed_video_topic_name").value;
      var data = JSON.stringify({"type": "configure", "subscribed_video_topic": subscribed_video_topic_name});
      connection.send(data);
  }

  connection.onopen = function () {
        try {
            pc = new RTCPeerConnection(null, pcOptions);
            pc.onicecandidate = function(event) {
                if (event.candidate) {
                    var candidate = {
                        sdp_mline_index: event.candidate.sdpMLineIndex,
                        sdp_mid: event.candidate.sdpMid,
                        candidate: event.candidate.candidate,
                        type: 'ice_candidate'
                    };
                    connection.send(JSON.stringify(candidate));
                } else {
                  console.log("End of candidates.");
                }
            };
            pc.onconnecting = onSessionConnecting;
            pc.onopen = onSessionOpened;
            pc.onaddstream = onRemoteStreamAdded;
            pc.onremovestream = onRemoteStreamRemoved;
        }
        catch (e) {
            console.log("Failed to create, exception: " + e.message);
        }

  };

    function onRemoteStreamAdded(event) {
      console.log(event);
      console.log("Remote stream added:", URL.createObjectURL(event.stream));
      var remoteVideoElement = document.getElementById('remote-video');
      remoteVideoElement.src = URL.createObjectURL(event.stream);
      remoteVideoElement.play();
    }
    function onSessionConnecting(message) {
        console.log("Session connecting.");
    }

    function onSessionOpened(message) {
        console.log("Session opened.");
    }

    function onRemoteStreamRemoved(event) {
        console.log("Remote stream removed.");
    }

  // Log errors
  connection.onerror = function (error) {
  console.log('WebSocket Error ' + error);
  };

  // Log messages from the server
  connection.onmessage = function (e) {
    var dataJson = JSON.parse(e.data);

    if (dataJson['type'] == 'offer') {
      console.log("Got offer:", dataJson);

      pc.setRemoteDescription(new RTCSessionDescription(dataJson), onRemoteSdpSucces, onRemoteSdpError);

      navigator.getUserMedia({"video": true}, function (stream) {
        var remoteVideoElement = document.getElementById('local-video');
        remoteVideoElement.src = URL.createObjectURL(stream);
        remoteVideoElement.play();

        pc.addStream(stream);
        pc.createAnswer(function(sessionDescription) {
            console.log("Create answer:", sessionDescription);
            pc.setLocalDescription(sessionDescription);
            var data = JSON.stringify(sessionDescription);
            connection.send(data);
        }, function(error) { // error
            console.log("Create answer error:", error);
        }, mediaConstraints);
      }, function(error) {
        console.error(error);
      });
    }
    else if(dataJson['type'] == 'ice_candidate'){
      console.log("Adding ICE candiate ", dataJson);
      var candidate = new RTCIceCandidate({sdpMLineIndex: dataJson.sdpMLineIndex, candidate: dataJson.candidate});
      pc.addIceCandidate(candidate);
    }
  };
  function onRemoteSdpError(event) {
    console.error('onRemoteSdpError', event);
    console.error('onRemoteSdpError', event.name, event.message);
  }

  function onRemoteSdpSucces() {
    console.log('onRemoteSdpSucces');
  }
</script>
</head>
<body>
    <div id="container">
        <video id="remote-video"></video>
        <video id="local-video"></video>
	<br>
	<form  onsubmit="configure();return false;">
	  Subscribed Video Topic: <input type="text" id="subscribed_video_topic_name" value="/image_raw">
	  <br>
	  <input type="submit" value="Configure">
	</form>
    </div>
</body>
</html>
